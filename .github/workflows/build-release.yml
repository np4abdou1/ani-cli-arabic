name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v1.0.5)"
        required: true
        type: string
      changelogs:
        description: "Release changelogs"
        required: true
        default: "Bug fixes and improvements"
        type: string

permissions:
  contents: write
  actions: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh release create "${{ inputs.version }}" --title "Release ${{ inputs.version }}" --notes "${{ inputs.changelogs }}"

  build-windows:
    needs: create-release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Inject version into source
        run: |
          $version = "${{ inputs.version }}"
          $versionContent = @"
# Version info for ani-cli-arabic
# This file gets updated by the build workflow

APP_VERSION = "$version"
APP_NAME = "ani-cli-arabic"
GITHUB_REPO = "np4abdou1/ani-cli-arabic"
RELEASES_URL = f"https://github.com/{GITHUB_REPO}/releases"
API_RELEASES_URL = f"https://api.github.com/repos/{GITHUB_REPO}/releases/latest"
"@
          Set-Content -Path "src/version.py" -Value $versionContent -Encoding UTF8
          
          # also create version info file for exe metadata
          $cleanVer = $version -replace '^v', ''
          $verParts = $cleanVer.Split('.')
          $major = if ($verParts.Length -gt 0) { $verParts[0] } else { "1" }
          $minor = if ($verParts.Length -gt 1) { $verParts[1] } else { "0" }
          $patch = if ($verParts.Length -gt 2) { $verParts[2] } else { "0" }
          
          $versionInfoContent = @"
VSVersionInfo(
  ffi=FixedFileInfo(
    filevers=($major, $minor, $patch, 0),
    prodvers=($major, $minor, $patch, 0),
    mask=0x3f,
    flags=0x0,
    OS=0x40004,
    fileType=0x1,
    subtype=0x0,
    date=(0, 0)
  ),
  kids=[
    StringFileInfo(
      [
        StringTable(
          u'040904B0',
          [
            StringStruct(u'CompanyName', u'np4abdou1'),
            StringStruct(u'FileDescription', u'ani-cli-arabic - Arabic Anime CLI'),
            StringStruct(u'FileVersion', u'$cleanVer'),
            StringStruct(u'InternalName', u'ani-cli-arabic'),
            StringStruct(u'LegalCopyright', u'MIT License'),
            StringStruct(u'OriginalFilename', u'ani-cli-arabic-win64.exe'),
            StringStruct(u'ProductName', u'ani-cli-arabic'),
            StringStruct(u'ProductVersion', u'$version')
          ]
        )
      ]
    ),
    VarFileInfo([VarStruct(u'Translation', [1033, 1200])])
  ]
)
"@
          Set-Content -Path "version_info.txt" -Value $versionInfoContent -Encoding UTF8

      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - run: |
          Invoke-WebRequest -Uri "https://github.com/shinchiro/mpv-winbuild-cmake/releases/download/20251125/mpv-i686-20251125-git-8469605.7z" -OutFile "mpv.7z"
          7z x mpv.7z
          Copy-Item -Path "mpv.exe" -Destination "mpv_bundle.exe" -Force

      - name: Build executables
        run: |
          New-Item -ItemType Directory -Force -Path build
          $currentDir = Get-Location
          $version = "${{ inputs.version }}"
          
          pyinstaller --onefile --name "ani-cli-arabic-$version-win64" --console --clean --noconfirm --distpath . --workpath build --specpath build --icon "$currentDir\assets\icon.ico" --version-file "$currentDir\version_info.txt" --add-data "$currentDir\src;src" --add-data "$currentDir\themes.py;." --add-data "$currentDir\database;database" --hidden-import pypresence --hidden-import rich --hidden-import requests --hidden-import cryptography --hidden-import cryptography.fernet main.py

          pyinstaller --onefile --name "ani-cli-arabic-$version-win64-with-mpv" --console --clean --noconfirm --distpath . --workpath build --specpath build --icon "$currentDir\assets\icon.ico" --version-file "$currentDir\version_info.txt" --add-data "$currentDir\src;src" --add-data "$currentDir\themes.py;." --add-data "$currentDir\database;database" --add-binary "$currentDir\mpv_bundle.exe;mpv" --hidden-import pypresence --hidden-import rich --hidden-import requests --hidden-import cryptography --hidden-import cryptography.fernet main.py
          
          # also create standard names without version for updater compatibility
          Copy-Item "ani-cli-arabic-$version-win64.exe" "ani-cli-arabic-win64.exe"
          Copy-Item "ani-cli-arabic-$version-win64-with-mpv.exe" "ani-cli-arabic-win64-with-mpv.exe"

      - env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          $version = "${{ inputs.version }}"
          gh release upload "$version" "ani-cli-arabic-$version-win64.exe" "ani-cli-arabic-$version-win64-with-mpv.exe" "ani-cli-arabic-win64.exe" "ani-cli-arabic-win64-with-mpv.exe"

  build-linux:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Inject version into source
        run: |
          VERSION="${{ inputs.version }}"
          cat > src/version.py << EOF
# Version info for ani-cli-arabic
# This file gets updated by the build workflow

APP_VERSION = "$VERSION"
APP_NAME = "ani-cli-arabic"
GITHUB_REPO = "np4abdou1/ani-cli-arabic"
RELEASES_URL = f"https://github.com/{GITHUB_REPO}/releases"
API_RELEASES_URL = f"https://api.github.com/repos/{GITHUB_REPO}/releases/latest"
EOF

      - run: |
          sudo apt-get update
          sudo apt-get install -y mpv libmpv-dev
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - run: |
          PWD=$(pwd)
          VERSION="${{ inputs.version }}"
          
          pyinstaller --onefile --name "ani-cli-arabic-$VERSION-linux-x64" --console --clean --noconfirm --distpath . --workpath build --specpath build --add-data "$PWD/src:src" --add-data "$PWD/themes.py:." --add-data "$PWD/database:database" --hidden-import pypresence --hidden-import rich --hidden-import requests --hidden-import cryptography --hidden-import cryptography.fernet main.py

          MPV_PATH=$(which mpv)
          pyinstaller --onefile --name "ani-cli-arabic-$VERSION-linux-x64-with-mpv" --console --clean --noconfirm --distpath . --workpath build --specpath build --add-data "$PWD/src:src" --add-data "$PWD/themes.py:." --add-data "$PWD/database:database" --add-binary "${MPV_PATH}:mpv" --hidden-import pypresence --hidden-import rich --hidden-import requests --hidden-import cryptography --hidden-import cryptography.fernet main.py
          
          # also create standard names without version for updater compatibility
          cp "ani-cli-arabic-$VERSION-linux-x64" "ani-cli-arabic-linux-x64"
          cp "ani-cli-arabic-$VERSION-linux-x64-with-mpv" "ani-cli-arabic-linux-x64-with-mpv"

      - env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          VERSION="${{ inputs.version }}"
          gh release upload "$VERSION" "ani-cli-arabic-$VERSION-linux-x64" "ani-cli-arabic-$VERSION-linux-x64-with-mpv" "ani-cli-arabic-linux-x64" "ani-cli-arabic-linux-x64-with-mpv"