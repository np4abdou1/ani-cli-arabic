name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v1.0.5)"
        required: true
        type: string
      changelogs:
        description: "Release changelogs"
        required: true
        default: "Bug fixes and improvements"
        type: string

permissions:
  contents: write
  actions: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh release create "${{ inputs.version }}" --title "Release ${{ inputs.version }}" --notes "${{ inputs.changelogs }}"

  build-windows:
    needs: create-release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Inject version into source
        shell: pwsh
        run: |
          $version = "${{ inputs.version }}"
          
          # Extract clean version (remove v prefix)
          $cleanVer = $version -replace '^v', ''
          
          # Update version.py with the release version
          @"
          # Version info for ani-cli-arabic
          # THIS IS THE SINGLE SOURCE OF TRUTH FOR VERSION
          # All other files (pyproject.toml, workflows, etc.) read from here

          __version__ = "$cleanVer"

          APP_VERSION = "$version"
          APP_NAME = "ani-cli-arabic"
          GITHUB_REPO = "np4abdou1/ani-cli-arabic"
          RELEASES_URL = f"https://github.com/{GITHUB_REPO}/releases"
          API_RELEASES_URL = f"https://api.github.com/repos/{GITHUB_REPO}/releases/latest"
          "@ | Out-File -FilePath "src/version.py" -Encoding utf8
          
          # Parse version numbers
          $cleanVer = $version -replace '^v', ''
          $verParts = $cleanVer.Split('.')
          $major = if ($verParts.Length -gt 0) { $verParts[0] } else { "1" }
          $minor = if ($verParts.Length -gt 1) { $verParts[1] } else { "0" }
          $patch = if ($verParts.Length -gt 2) { $verParts[2] } else { "0" }
          
          # Create version_info.txt
          $content = "VSVersionInfo("
          $content += "`n  ffi=FixedFileInfo("
          $content += "`n    filevers=($major, $minor, $patch, 0),"
          $content += "`n    prodvers=($major, $minor, $patch, 0),"
          $content += "`n    mask=0x3f,"
          $content += "`n    flags=0x0,"
          $content += "`n    OS=0x40004,"
          $content += "`n    fileType=0x1,"
          $content += "`n    subtype=0x0,"
          $content += "`n    date=(0, 0)"
          $content += "`n  ),"
          $content += "`n  kids=["
          $content += "`n    StringFileInfo("
          $content += "`n      ["
          $content += "`n        StringTable("
          $content += "`n          u'040904B0',"
          $content += "`n          ["
          $content += "`n            StringStruct(u'CompanyName', u'np4abdou1'),"
          $content += "`n            StringStruct(u'FileDescription', u'ani-cli-arabic - Arabic Anime CLI'),"
          $content += "`n            StringStruct(u'FileVersion', u'$cleanVer'),"
          $content += "`n            StringStruct(u'InternalName', u'ani-cli-arabic'),"
          $content += "`n            StringStruct(u'LegalCopyright', u'MIT License'),"
          $content += "`n            StringStruct(u'OriginalFilename', u'ani-cli-arabic-win64.exe'),"
          $content += "`n            StringStruct(u'ProductName', u'ani-cli-arabic'),"
          $content += "`n            StringStruct(u'ProductVersion', u'$version')"
          $content += "`n          ]"
          $content += "`n        )"
          $content += "`n      ]"
          $content += "`n    ),"
          $content += "`n    VarFileInfo([VarStruct(u'Translation', [1033, 1200])])"
          $content += "`n  ]"
          $content += "`n)"
          $content | Out-File -FilePath "version_info.txt" -Encoding utf8

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download MPV
        run: |
          Invoke-WebRequest -Uri "https://github.com/shinchiro/mpv-winbuild-cmake/releases/download/20251125/mpv-i686-20251125-git-8469605.7z" -OutFile "mpv.7z"
          7z x mpv.7z
          Copy-Item -Path "mpv.exe" -Destination "mpv_bundle.exe" -Force

      - name: Build executables
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path build
          $currentDir = Get-Location
          $version = "${{ inputs.version }}"
          
          # Build without MPV
          pyinstaller --onefile --name "ani-cli-arabic-windows-x64-$version" --console --clean --noconfirm --distpath . --workpath build --specpath build --icon "$currentDir\assets\icon.ico" --version-file "$currentDir\version_info.txt" --add-data "$currentDir\src;src" --add-data "$currentDir\themes.py;." --add-data "$currentDir\database;database" --hidden-import pypresence --hidden-import rich --hidden-import requests --hidden-import cryptography --hidden-import cryptography.fernet main.py
          
          # Build with MPV
          pyinstaller --onefile --name "ani-cli-arabic-windows-x64-$version-with-mpv" --console --clean --noconfirm --distpath . --workpath build --specpath build --icon "$currentDir\assets\icon.ico" --version-file "$currentDir\version_info.txt" --add-data "$currentDir\src;src" --add-data "$currentDir\themes.py;." --add-data "$currentDir\database;database" --add-binary "$currentDir\mpv_bundle.exe;mpv" --hidden-import pypresence --hidden-import rich --hidden-import requests --hidden-import cryptography --hidden-import cryptography.fernet main.py

      - name: Upload to release
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          $version = "${{ inputs.version }}"
          gh release upload "$version" "ani-cli-arabic-windows-x64-$version.exe" "ani-cli-arabic-windows-x64-$version-with-mpv.exe"

  build-linux:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Inject version into source
        run: |
          VERSION="${{ inputs.version }}"
          cat > src/version.py << 'VERSIONEOF'
          # Version info for ani-cli-arabic
          # This file gets updated by the build workflow

          APP_VERSION = "VERSION_PLACEHOLDER"
          APP_NAME = "ani-cli-arabic"
          GITHUB_REPO = "np4abdou1/ani-cli-arabic"
          RELEASES_URL = f"https://github.com/{GITHUB_REPO}/releases"
          API_RELEASES_URL = f"https://api.github.com/repos/{GITHUB_REPO}/releases/latest"
          VERSIONEOF
          
          sed -i "s/VERSION_PLACEHOLDER/$VERSION/g" src/version.py

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y mpv libmpv-dev
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executables
        run: |
          PWD=$(pwd)
          VERSION="${{ inputs.version }}"
          
          # Build without MPV
          pyinstaller --onefile --name "ani-cli-arabic-linux-x64-$VERSION" --console --clean --noconfirm --distpath . --workpath build --specpath build --add-data "$PWD/src:src" --add-data "$PWD/themes.py:." --add-data "$PWD/database:database" --hidden-import pypresence --hidden-import rich --hidden-import requests --hidden-import cryptography --hidden-import cryptography.fernet main.py
          
          # Build with MPV
          MPV_PATH=$(which mpv)
          pyinstaller --onefile --name "ani-cli-arabic-linux-x64-$VERSION-with-mpv" --console --clean --noconfirm --distpath . --workpath build --specpath build --add-data "$PWD/src:src" --add-data "$PWD/themes.py:." --add-data "$PWD/database:database" --add-binary "${MPV_PATH}:mpv" --hidden-import pypresence --hidden-import rich --hidden-import requests --hidden-import cryptography --hidden-import cryptography.fernet main.py

      - name: Upload to release
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          VERSION="${{ inputs.version }}"
          gh release upload "$VERSION" "ani-cli-arabic-linux-x64-$VERSION" "ani-cli-arabic-linux-x64-$VERSION-with-mpv"